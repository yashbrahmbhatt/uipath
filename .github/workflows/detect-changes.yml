# .github/workflows/detect-changes.yml

name: Detect Changed Projects

on:
  workflow_call:
    outputs:
      matrix:
        description: "Changed projects matrix"
        value: ${{ jobs.detect.outputs.matrix }}

jobs:
  detect:
    runs-on: [windows, self-hosted]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v3

      - name: Download jq
        run: |
          Invoke-WebRequest -Uri https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe -OutFile jq.exe
        shell: powershell

      - name: Add jq to PATH
        run: |
          $env:PATH = "$PWD;$env:PATH"
          jq.exe --version
        shell: powershell

      - name: Detect Changed Projects
        id: set-matrix
        run: |
          echo "Detecting changes..."
          changed=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Changed files:"
          echo "$changed"

          # Load mono.json and initialize output array
          projects=$(cat mono.json | jq -c '.projects[]')
          matched='[]'

          while read -r proj; do
            path=$(echo "$proj" | jq -r '.path')
            build=$(echo "$proj" | jq -r '.build')

            if [[ "$build" != "true" ]]; then
              continue
            fi

            if echo "$changed" | grep -q "^$path/"; then
              matched=$(echo "$matched" | jq --argjson proj "$proj" '. + [$proj]')
            fi
          done <<< "$projects"

          matrix=$(echo "$matched" | jq '{include: map({id: .id, path: .path, type: .type, deploySteps: .deploySteps})}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
