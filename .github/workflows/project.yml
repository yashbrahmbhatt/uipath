name: Build Project

on:
  workflow_call:
    inputs:
      id: { required: true, type: string }
      path: { required: true, type: string }
      type: { required: true, type: string }


      
jobs:
  compute-version:
    uses: ./.github/workflows/step-compute-version.yml
    with:
      id: ${{ inputs.id }}

  build-artifact:
    needs: compute-version
    uses: ./.github/workflows/step-build-artifact.yml
    with:
      id: ${{ inputs.id }}
      folder_path: ${{ inputs.path }}
      version: ${{ needs.compute-version.outputs.version }}
      full_version: ${{ needs.compute-version.outputs.full_version }}
      type: ${{ inputs.type }}

  tag:
    needs: [build-artifact, compute-version]
    uses: ./.github/workflows/step-create-github-tag.yml
    with:
      id: ${{ inputs.id }}
      version: ${{ needs.compute-version.outputs.version }}
      full_version: ${{ needs.compute-version.outputs.full_version }}

  release:
    needs: [tag, build-artifact, compute-version]
    runs-on: [self-hosted, windows]
    steps:
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.github_token }}
        with:
          tag_name: ${{ needs.compute-version.outputs.full_version }}
          release_name: Release ${{ needs.compute-version.outputs.full_version }}
          draft: false
          prerelease: false

  publish-github:
    needs: [release, tag, build-artifact, compute-version]
    uses: ./.github/workflows/step-publish-to-GitHub.yml
    with:
      artifact-id: ${{  needs.build-artifact.outputs.artifact-id }}
      full_name: ${{ needs.compute-version.outputs.full_version }}.nupkg
      repository_owner: ${{ github.repository_owner }}

  publish-nuget:
    needs: [release, tag, build-artifact, compute-version]
    uses: ./.github/workflows/step-publish-to-NuGet.yml
    with:
      nupkg_path: ${{ inputs.path }}/bin/Release/${{ needs.compute-version.outputs.full_version }}.nupkg
    secrets: inherit
